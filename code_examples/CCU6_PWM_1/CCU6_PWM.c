/**********************************************************************************************************************
 * \file CCU6_PWM.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/******************************************************************************/
/*----------------------------------Includes----------------------------------*/
/******************************************************************************/
#include "CCU6_PWM.h"

/******************************************************************************/
/*------------------------------Global variables------------------------------*/
/******************************************************************************/
#define CCU6_BASE_FREQUENCY	100000000                                /* CCU6 Base frequency, in Hertz */
#define PWM_FREQUENCY       20000                                    /* PWM signal frequency, in Hertz */
#define PWM_PERIOD          (CCU6_BASE_FREQUENCY / PWM_FREQUENCY)    /* PWM signal period, in ticks */

#define CHANNEL1_DUTY_CYCLE    25                                    /* PWM Signal 1 Duty cycle, in percent */
#define CHANNEL2_DUTY_CYCLE    50                                    /* PWM Signal 2 Duty cycle, in percent */
#define CHANNEL3_DUTY_CYCLE    75                                    /* PWM Signal 3 Duty cycle, in percent */

#define CHANNEL1_COMPARE_VALUE     ((PWM_PERIOD / 100) * (100 - CHANNEL1_DUTY_CYCLE))
#define CHANNEL2_COMPARE_VALUE     ((PWM_PERIOD / 100) * (100 - CHANNEL2_DUTY_CYCLE))
#define CHANNEL3_COMPARE_VALUE     ((PWM_PERIOD / 100) * (100 - CHANNEL3_DUTY_CYCLE))

IfxCcu6_TimerWithTrigger timerDriver;
IfxCcu6_PwmHl driver;

/******************************************************************************/
/*-------------------------Function Implementations---------------------------*/
/******************************************************************************/
void initPeripherals(void)
{
    boolean interruptState = IfxCpu_disableInterrupts();                /* Disable global interrupts */

    IfxCcu6_TimerWithTrigger_Config timerConfig;                        /* Configuration for the timer used as counter */
    IfxCcu6_TimerWithTrigger_initConfig(&timerConfig, &MODULE_CCU60);   /* Initialize timer configuration with default values and address of CCU6 module */
    timerConfig.base.frequency = PWM_FREQUENCY;                         /* Set the desired frequency for the PWM signal (20Khz). */
                                                                        /* Being the default internal module clock 100Mhz, the calculated period value will be: 100e6 Hz / 20e3 Hz = 5000 ticks.*/
    timerConfig.base.countDir = IfxStdIf_Timer_CountDir_upAndDown;      /* Configure the timer to count up and down, in order to generate center-aligned pwm signals*/
    IfxCcu6_TimerWithTrigger_init(&timerDriver, &timerConfig);          /* Initialize the timer driver, using the configuration created above */

    IfxCcu6_PwmHl_Config config;                                        /* Configuration of the PWM High/Low driver */
    IfxCcu6_PwmHl_initConfig(&config);                                  /* Initialize the PwmHl configuration with default values */

    config.timer = &timerDriver;                                        /* Instruct the PwmHl driver to use the already configured timer */
    config.base.channelCount = 3;                                       /* Configure the PwmHl driver to use use all three compare modules available to T12 */
    config.cc0 = &IfxCcu60_CC60_P02_0_OUT;                              /* ****************** */
    config.cc1 = &IfxCcu60_CC61_P02_2_OUT;                              /*                    */
    config.cc2 = &IfxCcu60_CC62_P02_4_OUT;                              /* Assign output pins */
    config.cout0 = &IfxCcu60_COUT60_P02_1_OUT;                          /*                    */
    config.cout1 = &IfxCcu60_COUT61_P02_3_OUT;                          /*                    */
    config.cout2 = &IfxCcu60_COUT62_P02_5_OUT;                          /* ****************** */

    IfxCcu6_PwmHl_init(&driver, &config);                               /* Initialize the PwmHl driver */

    IfxCcu6_PwmHl_setMode(&driver, Ifx_Pwm_Mode_centerAligned);         /* Instructs the driver to generate center aligned PWM signals */

    Ifx_TimerValue cmpValues[3];                                        /* Array for the compare values, used to control the duty cycle of the PWM signals */
    cmpValues[0] = CHANNEL1_COMPARE_VALUE;                              /* Set the compare value for channel 1 */
    cmpValues[1] = CHANNEL2_COMPARE_VALUE;                              /* Set the compare value for channel 2 */
    cmpValues[2] = CHANNEL3_COMPARE_VALUE;                              /* Set the compare value for channel 3 */

    driver.update(&driver, cmpValues);                                  /* Set the compare values */

    IfxCcu6_TimerWithTrigger_applyUpdate(driver.timer);                 /* Update the timer. This instruction enables the shadow transfer of the compare values, copying the compare values to the compare registers */

    IfxCpu_restoreInterrupts(interruptState);                           /* Restore interrupts to their initial state */

    IfxCcu6_TimerWithTrigger_run(&timerDriver);                         /* Enable timer operation. Also starts the generation of the PWM signals. */

}
